# Интеграция с i-bonus.me

## Введение

Для интеграции с i-bonus.me используется REST API. Используемая кодировка UTF-8. Текущий url для отладки [https://lk.i-bonus.me/](https://lk.i-bonus.me/)

## Авторизация

Все завпросы выполняются с авторизацией. Авторизация производится с помощью Basic Auth. Для этого в каждом запросе к REST API необходимо передавать заголовок Authorization. Подробнее [Wiki](https://en.wikipedia.org/wiki/Basic_access_authentication#Client_side). 

## Формат данных

Все ответы возвращаются в формате JSON. Кодировка UTF-8.

## Коды ответов

Коды ответа | Описание
----------- | --------
2xx | Запрос выполнен успешно
4xx | Ошибка в данных передаваемых в запросе, либо в самом запросе
5xx | Ошибка на серверной стороне

## Формат вывода ошибок
В случае возникновения какой либо ошибки в ответ возвращается json с описанием самой ошибки.

```json
{
    "error": "Not Found", 
    "message": "Video with id=1 is not found.", 
    "path": "/ext/api/v1/videos/1/generate_link/", 
    "status": 404, 
    "timestamp": 1513521246746
}
```

# 1. Получаем список клиентов, находим нужного нам. 

* **URL**

`/ext/api/v1/clients/`

* **Метод**

`GET`

* **URL параметры**

Название поля | Описание
------------- | --------
phone | Номер телефона. Часть передаваемой строки может быть заменена на %. Необязательный параметр.
email | Email клиента. Часть передаваемой строки может быть заменена на %. Необязательный параметр.
offset | Число. Порядковый номер с которого будет произведена выдача(начинается с 0). Необязательный параметр.
limit | Число. Ограничение на кол-во записей в выдаче. Необязательный параметр.

* **Параметры данных**

Отсутствуют

* **Пример ответа**

```json
[{
    "id" : 1234567,
    "email" : "test@test.ru",
    "phone" : "7912345678",
    "name" : "Client First",
    "avatarUrl": "https://test.com/image/123.jpg",
    "paidPurchases" : 1,
    "totalPurchases" : 2,
    "averageBill" : 100.5,
    "totalPurchasesAmount" : 1234.4,
    "paidPurchasesAmount": 123.5,
    "positiveReviews": 1,
    "neutralReviews": 0,
    "negativeReviews": 2,
    "token": "12345667890abcdef"
}]
     
```

## 2. Получаем список купонов клиента.
* **URL**

`/ext/api/v1/clients/{id}/coupons/`

* **Метод**

`GET`

* **URL параметры**

Название поля | Описание
------------- | --------
{id} | Идентификатор клиента.

* **Параметры данных**

Отсутствуют

* **Пример ответа**

```json
[{
    "id": 123,
    "title":"Internal title",
    "header":"Заголовок",
    "subHeader": "Подзаголовок",
    "shortDescription": "Короткое описание",
    "longDescription" : "Длинное описание",
    "expireDate": 1571408400000,
    "token" : "12345667890abcdef",
    "shareToken" :  "12345667890abcdef",
    "merchantToken": "123456",
    "merchantShareToken" : "654321"
}]
     
```

* **Описание параметров ответа**

Название поля | Описание
------------- | --------
id | Идентификатор купона.
title | Служебный заголовок. Может отсутствовать.
header | Заголовок. Может отсутствовать.
subHeader | Подзаголовок. Может отсутствовать.
shortDescription | Короткое описание. Может отсутствовать. Может содержать html теги.
longDescription | Длинное описание. Может отсутствовать. Может содержать html теги.
expireDate | Время по которое купон валиден.
token | Токен до 32 символов. HEX. Уникальный токен пары клиент - купон. Генерируется iBonus.
shareToken | Токен до 32 символов. HEX. Уникальный токен пары клиент - купон для расшаривания. Используется в методе погашения расшаренного купона. Генерируется iBonus.
merchantToken | Токен до 32 символов. HEX. Уникальный токен пары клиент - купон. На данный момент генерируется iBonus. Шесть цифр.
merchantShareToken | Токен до 32 символов. HEX. Уникальный токен пары клиент - купон для расшаривания. На данный момент генерируется iBonus. Шесть цифр.

## 3. Получаем баланс клиента
* **URL**

`/ext/api/v1/clients/{id}/balance/`

* **Метод**

`GET`

* **URL параметры**

Название поля | Описание
------------- | --------
{id} | Идентификатор клиента.

* **Параметры данных**

Отсутствуют

* **Пример ответа**

```json
[{
    "amount" : 1234.56,
    "currency" : "points"
}, {
    "amount" : 4321.06,
    "currency" : "rubles"
}]
     
```

* **Описание параметров ответа**

Название поля | Описание
------------- | --------
amount | Сумма доступная для списания.
currency | Валюта. Пока только points и rubles.


## 4. Создание заказа 

* **URL**

`/ext/api/v1/fiscal/orders/`

* **Метод**

`POST`

* **URL параметры**

Отсутствуют

* **Пример запроса создания заказа**

```json
{
  "order": {
     "receiptType": "sale", 
     "amountCard": 20,
     "amountCash": 10,
     "customerEmail": "test@test.com",
     "customerPhone": "791234567890",
     "externalId": "12345678",
     "items": [{
       "price": 10, 
         "quantity": 1, 
         "unit": "piece", 
         "vat": 20, 
         "name": "Капучино"
     }]
  },
  "amount": 10,
  "currency": "points",
  "coupons": [1, 2]
}
```


* **Описание параметров запроса**

***Поля запроса***

Название поля | Описание
------------- | --------
order | Описание заказа, обязательное поле
amount | Какую сумму надо списать с бонусного счета клиента
currency | Валютаа бонусного счета
coupons | Какие купоны надо погасить при добавлении заказа

***Поля order***

Название поля | Описание
------------- | --------
externalId | Номер заказа во внешней системе.
receiptType | Тип чека. sale, refund. Если будет передан refund, то ранее начисленные бонусы купоны будут отменены, а ранее списанны бонусы будут возвращены
amountCard | Сумма, оплаченная картой. Необязательный параметр.
amountCash | Сумма, оплаченная наличными. Необязательный параметр.
customerEmail | Email покупателя. Необязательный параметр.
customerPhone | Номер телефона покупателя. Необязательный параметр.
items.Id | Id товара внутри системы.
items.price | Цена товара
items.quantity | Количество товара
items.unit | В чем измеряется кол-во товара. piece, kg, g, L, ml 
items.vat | Размер НДС
items.name | Название товара

* **Пример ответа**

200 OK
